name: Build

on: [push, pull_request]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: "Checkout"
        uses: actions/checkout@v2

      - name: "Install MSBuild"
        uses: microsoft/setup-msbuild@v1.1

      - name: "Restore Dependencies"
        run: msbuild -t:restore "src\ParallelHelper.sln"

      - name: "Build"
        run: msbuild /property:Configuration=Release "src\ParallelHelper.sln"

      - name: "Install Coverlet"
        uses: actions/setup-dotnet@v1
        run: dotnet tool install --global coverlet.console --version 1.7.0

      - name: "Test"
        shell: pwsh
        run: coverlet src\ParallelHelper.Test\bin\Release\netcoreapp3.1\ParallelHelper.Test.dll --target "dotnet" --targetargs 'test src\ParallelHelper.Test -c Release -logger:""C:\Program Files\AppVeyor\BuildAgent\dotnetcore\Appveyor.MSBuildLogger.dll"" --no-build' --format opencover --output coverage.xml

      - name: "Create Coverage Report"
        run: |
          dotnet tool install --global Codecov.Tool
          codecov -f "coverage.xml"

      - name: "Upload Coverage Report"
        uses: codecov/codecov-action@v2
        with:
          files: ./coverage.xml
